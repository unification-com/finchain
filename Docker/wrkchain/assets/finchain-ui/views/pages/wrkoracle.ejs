<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%= WRKCHAIN_NAME%> Block Validator</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <header>
      <!-- Fixed navbar -->
      <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="#"><%= WRKCHAIN_NAME%></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item"><a class="nav-link" href="/">$tock Watcher</a></li>
            <li class="nav-item active"><a class="nav-link" href="/wrkoracle">WRKOracle Watcher</a></li>
            <li class="nav-item"><a class="nav-link" href="/validate"><%= WRKCHAIN_NAME%> Block Validation</a></li>
            <li class="nav-item"><a class="nav-link" href="<%= WRKCHAIN_EXPLORER_URL%>" target="_blank"><%= WRKCHAIN_NAME%> Block Explorer</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <!-- Begin page content -->
    <main role="main" class="container">
        <br>
        <h1 class="mt-5">Latest <%= WRKCHAIN_NAME%> Block recorded on Mainchain</h1>
        <h2>WRKChain Network ID: <%= WRKCHAIN_NETWORK_ID%></h2>
    <p class="lead">
        <strong>Status: </strong> <span id="status"></span><br>

        <table class="table table-dark" style="visibility:none;">
            <thead>
                <tr>
                    <td colspan="2">
                        <h3><%= WRKCHAIN_NAME%> Block #<span id="block_num"></span> Submitted to Mainchain (<a href="#" id="validate_link">Validate block</a>)</h3>
                    </td>
                </tr>
            </thead>
            <tbody id="loading_table">
            <tr>
                <td>
                    <div class="load-container">
                        <div class="loader">Loading...</div>
                    </div>
                </td>
            </tr>
            </tbody>
            <tbody id="results_table">
                <tr>
                    <td>Hash</td>
                    <td><span id="hash"></span></td>
                </tr>
                <tr>
                    <td>Parent Hash</td>
                    <td><span id="parent_hash"></span></td>
                </tr>
                <tr>
                    <td>Receipt Root</td>
                    <td><span id="receipt_root"></span></td>
                </tr>
                <tr>
                    <td>Tx Root</td>
                    <td><span id="tx_root"></span></td>
                </tr>
                <tr>
                    <td>State Root</td>
                    <td><span id="state_root"></span></td>
                </tr>
                <tr>
                    <td>Current Time</td>
                    <td><span id="block_time"></span></td>
                </tr>
                <tr>
                    <td colspan="2">
                    <h3>Mainchain Event: <span id="mainchain_event"></span></h3>
                    </td>
                </tr>
                <tr>
                    <td>
                        Submitted in Mainchain Tx
                    </td>
                    <td>
                        <a target="_blank" id="tx" data-toggle="tooltip" data-placement="bottom" title="Hashes were submitted to Mainchain in this Tx. Click to view in the Mainchain Block Explorer"></a>
                    </td>
                </tr>
                <tr>
                    <td>
                        Submitted in Mainchain Block
                    </td>
                    <td>
                        #<a target="_blank" id="mainchain_block_num" data-toggle="tooltip" data-placement="bottom" title="Hashes were included in this Mainchain block. Click to view in the Mainchain Block Explorer"></a>
                    </td>
                </tr>
                <tr>
                    <td>
                        Mainchain Signature
                    </td>
                    <td>
                        <span id="mainchain_sig"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        Next check
                    </td>
                    <td>
                        <span id="next_block"><%= WRKCHAIN_WRITE_TIMEOUT%></span>
                    </td>
                </tr>
            </tbody>
        </table>

        <h2>WRKOracle Submission history</h2>
        <table class="table table-dark">
            <thead>
            <tr>
                <th><%= WRKCHAIN_NAME%> Block #</th>
                <th>Mainchain Block #</th>
                <th>Mainchain Tx</th>
                <th style="width: 150px;">Validate</th>
            </tr>
            </thead>
            <tbody id="wrkoracle_history">
                 <tr>
                     <td colspan="7">
                         <div class="load-container">
                             <div class="loader">Loading...</div>
                         </div>
                     </td>
                 </tr>
            </tbody>
        </table>

    </main>

    <footer class="page-footer font-small pt-4">
        <div class="container">
            <!-- Copyright -->
            <div class="footer-copyright text-center py-3">&copy; 2019
                <a href="https://unification.com"> unification.com</a> | <a href="https://github.com/unification-com/finchain">View on Github</a>
            </div>
        </div>
    </footer>

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Popper JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

<script type="text/javascript" src="/js/web3.min.js"></script>
    <script type="text/javascript" src="/js/WRKChainEventWatcher.proto.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>


<script type="text/javascript">

    $(document).ready(function () {

        let wrkChainEventWatcher = new WRKChainEventWatcher('<%= MAINCHAIN_REST_URL%>',
                                                            '<%= WRKCHAIN_ID%>',
                                                            '<%= WRKCHAIN_OWNER%>');
        updateWatcher();
        setInterval(function(){
            updateWatcher();
        }, <%= WRKCHAIN_WRITE_TIMEOUT%> * 1000);

        setInterval(function(){
            nextCheck();
        }, 1000);

        function updateWatcher() {
            $('#results_table').hide();
            $('#loading_table').show();
            $('#status').html('Fetching data <i class="material-icons large">info<i>').css('color', 'blue');
            $('#next_block').text(<%= WRKCHAIN_WRITE_TIMEOUT%> + 1);
            wrkChainEventWatcher.getLatestRecordedHeader(function(success, txs) {
                $('#results_table').show();
                $('#loading_table').hide();
                if(success && txs != undefined) {
                    $('#wrkoracle_history').html('');
                    let latestSubmission = txs[0];
                    let msg = latestSubmission.tx.value.msg[0].value;

                    let now = new Date(Date.now());
                    $('#block_num').text(msg.height);
                    $('#block_time').text(now.toString());
                    $('#tx').text(latestSubmission.txhash);
                    $('#tx').attr('href','<%= MAINCHAIN_EXPLORER_URL%>/transactions/' + latestSubmission.txhash);

                    $('#mainchain_block_num').text(latestSubmission.height);
                    $('#mainchain_block_num').attr('href','<%= MAINCHAIN_EXPLORER_URL%>/blocks/' + latestSubmission.height);
                    $('#mainchain_sig').text(latestSubmission.tx.value.signatures[0].signature);

                    $('#hash').text(msg.blockhash);
                    $('#parent_hash').text(msg.parenthash);
                    $('#receipt_root').text(msg.hash1);
                    $('#tx_root').text(msg.hash2);
                    $('#state_root').text(msg.hash3);

                    $('#status').html('Success <i class="material-icons large">check_circle_outline<i>').css('color', 'green');;

                    $('#validate_link').attr('href','/validate/' + msg.height);

                    $('#wrkoracle_history').html('');

                    for(i=1; i<txs.length; i++) {
                        let msg = txs[i].tx.value.msg[0].value;
                        let historyHtml = '<tr>';
                        historyHtml += '<td>';
                        historyHtml += '<a href="/explorer/block/' + msg.height + '" target="_blank" data-toggle="tooltip" data-placement="bottom" title="View Block #' + msg.height + ' in Finchain Explorer">';
                        historyHtml += msg.height;
                        historyHtml += '</a>';
                        historyHtml += '</td>';
                        historyHtml += '<td>';
                        historyHtml += '<a href="<%= MAINCHAIN_EXPLORER_URL%>/blocks/' + txs[i].height + '" target="_blank" data-toggle="tooltip" data-placement="bottom" title="View Block in Mainchain Explorer">' + txs[i].height + '</a>';
                        historyHtml += '</td>';
                        historyHtml += '<td>';
                        historyHtml += '<a href="<%= MAINCHAIN_EXPLORER_URL%>/transactions/' + txs[i].txhash + '" target="_blank" data-toggle="tooltip" data-placement="bottom" title="View Tx in Mainchain Explorer">' + txs[i].txhash + '</a>';
                        historyHtml += '</td>';
                        historyHtml += '<td>';
                        historyHtml += '<a href="/validate/' + msg.height + '" data-toggle="tooltip" data-placement="bottom" title="Validate Block #' + msg.height + '"><i class="material-icons large">open_in_new</i></a>';
                        historyHtml += '</td>';
                        historyHtml += '</tr>';
                        $('#wrkoracle_history').append(historyHtml);
                    }

                    $('[data-toggle="tooltip"]').tooltip();

                } else {
                    console.log(data);
                    $('#status').html('Please refresh to try again <i class="material-icons large">cancel<i>').css('color', 'red');
                }
            });
        }

        function nextCheck() {
            let current = parseInt($('#next_block').text());
            let next = current - 1;
            if(next < 0) {
                next = 0;
            }
            $('#next_block').text(next)
        }
    });
</script>
</body>
</html>
